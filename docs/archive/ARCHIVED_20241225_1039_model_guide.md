# Marian Model Guide

## Overview
This guide explains how to work with Marian's SQLAlchemy models. For related documentation:
- Design decisions: See [Database Design](database_design.md)
- Coding standards: See [Code Standards](code_standards.md)
- Architecture: See [ADR001](decisions/ADR001_SQLAlchemy_Models_as_Source_of_Truth.md)

## Model Structure

### Base Model
All models inherit from `models.base.Base`:
```python
from models.base import Base

class YourModel(Base):
    __tablename__ = 'your_table'
```

### Core Models
1. **Email Model** (`models/email.py`)
   - Stores email data from Gmail
   - Primary key: Gmail message ID
   - Relationships: Thread ID

2. **Catalog Model** (`models/catalog.py`)
   - Manages catalog items and tags
   - Supports relationships between items
   - Case-insensitive tag handling

3. **Analysis Model** (`models/email_analysis.py`)
   - Stores email analysis results
   - Links to emails via foreign key
   - JSON field for flexible data storage

## Working with Models

### Creating Records
```python
from models.catalog import CatalogItem, Tag

# Create a catalog item
item = CatalogItem(
    title="Example Item",
    description="An example item",
    content="Item content"
)

# Create with relationships
item.tags = [Tag(name="example"), Tag(name="demo")]
```

### Querying
```python
from sqlalchemy import select
from models.catalog import CatalogItem

# Get item by ID
item = session.get(CatalogItem, item_id)

# Query with filters
items = session.execute(
    select(CatalogItem)
    .where(CatalogItem.title.ilike('%search%'))
).scalars()

# Query relationships
items_with_tag = session.execute(
    select(CatalogItem)
    .join(CatalogItem.tags)
    .where(Tag.name == "example")
).scalars()
```

### Validation
Models provide runtime type checking:
```python
# Type error caught at runtime
item.title = 123  # Error: expected str, got int

# Nullable fields
item.description = None  # OK if nullable=True
```

### Relationships
Models handle relationships automatically:
```python
# Many-to-many relationship
item.tags.append(new_tag)  # Handles join table

# One-to-many relationship
analysis.email = email  # Sets foreign key
```

## Schema Changes

### Making Changes
1. Review design decisions in database_design.md
2. Update the relevant model following code_standards.md
3. Generate migration with alembic
4. Run migration
5. Update tests if needed

Example:
```bash
# After updating model
alembic revision --autogenerate -m "Add new field"
alembic upgrade head
```

### Best Practices
See [Code Standards](code_standards.md) for complete guidelines. Key points:
1. **Type Safety**
   - Use SQLAlchemy 2.0 type hints
   - Set nullable explicitly
   - Use appropriate column types

2. **Documentation**
   - Follow project docstring format
   - Explain constraints
   - Note requirements

3. **Relationships**
   - Use appropriate cascade rules
   - Set up backrefs when useful
   - Consider lazy loading settings

4. **Testing**
   - Test model constraints
   - Verify relationships
   - Check edge cases

## Common Patterns

### Soft Delete
```python
deleted: Mapped[bool] = mapped_column(
    Boolean,
    default=False,
    nullable=False
)
```

### Timestamps
```python
created_date: Mapped[int] = mapped_column(
    Integer,
    default=lambda: int(datetime.utcnow().timestamp()),
    nullable=False
)
```

### Case-Insensitive Search
```python
__table_args__ = (
    Index('idx_name', text('name COLLATE NOCASE')),
)
```

### JSON Fields
```python
metadata: Mapped[Optional[Dict[str, Any]]] = mapped_column(JSON)
```

## Troubleshooting

### Common Issues
1. **Relationship Load Error**
   - Check lazy loading settings
   - Ensure session is active
   - Verify relationship definition

2. **Type Errors**
   - Verify field types match model
   - Check nullable settings
   - Ensure JSON fields are serializable

3. **Migration Issues**
   - Backup database before migrating
   - Check for pending migrations
   - Review autogenerated migrations

## Further Reading
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/en/20/)
- [Alembic Documentation](https://alembic.sqlalchemy.org/en/latest/)
- Project ADRs in `docs/decisions/`
